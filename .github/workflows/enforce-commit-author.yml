name: Enforce Commit Authors

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  check-commit-authors:
    name: Check Commit Authors
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify commit authors
        env:
          ALLOWED_EMAILS: |
            jacob.thiel@nuview.space
            jacob@racelay.com
            cooknick30@gmail.com
        run: |
          echo "Checking commits for allowed authors..."

          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            # For PRs, check commits between base and head
            RANGE="$GITHUB_BASE_REF..$GITHUB_HEAD_REF"
            COMMITS=$(git rev-list origin/$GITHUB_BASE_REF..HEAD || true)
          else
            if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              COMMITS=$(git rev-list -n 1 ${GITHUB_SHA} || true)
            else
              COMMITS=$(git rev-list ${{ github.event.before }}..${{ github.sha }} || true)
            fi
          fi

          if [ -z "$COMMITS" ]; then
            echo "No commits to inspect. Exiting check."
            exit 0
          fi

          invalid=false
          for c in $COMMITS; do
            email=$(git log -1 --format='%ae' $c)
            if ! echo "$ALLOWED_EMAILS" | grep -q "^$email$"; then
              echo "Unauthorized commit author detected: $email (commit $c)"
              invalid=true
            fi
          done

          if [ "$invalid" = true ]; then
            echo "One or more commits are authored by an unauthorized email. Failing check."
            exit 1
          fi

          echo "All commit authors are allowed."
